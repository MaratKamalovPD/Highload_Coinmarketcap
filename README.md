# Highload Coinmarketcap
Проект по курсу "Проектирование высоконагруженных систем" VK Education в МГТУ.

## 1. Тема и целевая аудитория 
**Coinmarketcap**  —  веб-сервис для отслеживания цен на криптовалютные активы.

### Ключевой функционал (MVP)
- Получение актуальных данных о ценах на криптовалюты
- Получение ранжированного списка криптовалют
- Получение исторических данных
- Получение уведомлений о достижении цены определённых значений
- Получение ранжированного списка криптобирж
- Получение аналитических данных

### Целевая аудитория
Веб-сервис имеет около 80 миллионов активных пользователей в месяц.
Данные о месячной аудитории по странам представлены в таблице.

| Страна    | Количество пользователей в месяц, млн |
| --------- | ------------------------------------- |
| США       | 22,26                                 |
| Бразилия  | 8,84                                  |
| Германия  | 8,31                                  |
| Индия     | 7,85                                  |
| Индонезия | 5,77                                  |


## 2. Расчет нагрузки

### Продуктовые метрики

По данным сайта [hypestat](https://hypestat.com/info/coinmarketcap.com) 

* Дневная аудитория(DAU) - 2.8 млн
* Месячная аудитория(MAU) - 85.2 млн


### Объем сохраняемых данных

В открытых источниках нет информации, сколько всего пользователей зарегистрировано в CoinmarketCap.
Но всего по данным на 2023 год владельцами криптовалют (то есть наиболее вероятными пользователями сервиса) являются 580 млн. человек.
Также стоит отметить, что даже незарегистрированным пользователям доступен практически полный функционал веб-сервиса. Единственное преимущество, которое даёт регистрация - возможность получаения уведомлений.
Из открытых источников не не удалось узначать, какой процент пользователей заходит просто посмотреть на цену, а какой ещё и выставляет уведомления об изменении цен.
Но в своих расчётах я буду опираться на цифру в 50 млн зарегистрированных пользователей:

| хранимые данные           | средний размер         |  суммарный объем |
|---------------------------|------------------------|------------------|
| профиль пользователя      | 5  Кб                  |   250 Гб         | 

В профиль пользователя входят:
* Базовые данные профиля (имя, email, пароль, дата регистрации, соцсети, 2FA и т.д.)
* Перечать отслеживаемых криптовалют (уведомления об изменениии цены, хранение списка отслеживаемых криптовалют)


### Запросы пользователей в день и RPS

В открытых источниках мне не удалось найти данные о количестве различных действий пользователя в день. Поэтому я использовал данные сайта [hypestat](https://hypestat.com/info/coinmarketcap.com), согласно которым в день посещается 7 679 805 страниц или 2.73 страницы на пользователя в день

Предположительные данные по среднему количеству запросов пользователя представлены в таблице ниже. RPS можно вычислить по формуле: RPS = среднее_кол-во_действий_в_день * DAU / 86400

Я предполагаю, что пиковый RPS привязан к определённым событиям в криптомире и составляет до х100 от среднего
Для такого коэффициента существуют следующие обоснования:
1. Цена абсолютного большинства криптовалют в большей или меньшей степени кореллируют с биткоином. Биткоин в свою очередь коррелирует с фондовым рынком. 
2. Если посмотреть на исторические данные, то можно заметить, что на цену криптовалют влияют следующие факторы: денежно-кредитная политика, экономическая ситуация, геополитика, изменения в регулировании.

Из пунктов 1 и 2 следует, во-первых, что криптовалюты либо растут либо падают относительно синхронно, а, во-вторых, что это падение зачастую привязано к новостям по определённым темам. Соответственно в момент выхода таких новостей и будет наступать пиковый RPS за счёт того, что пользователи пойдут смотреть на цены, а также сервис начнёт отправлять уведомления большому числу пользователей.


| посещаемые страницы                               | среднее количество в день на пользователя | средний RPS  | пиковый RPS |
|---------------------------------------------------|:-----------------------------------------:|--------------|-------------|
| посещение главной страницы                        |                   1                       | 32           |  3200       |
| посещение страницы отдельно взятой криптовалюты   |                   1.7                     | 55           |  5500       |
| получение ранжированного списка криптобирж        |                   0.03                    | 1            |  100        |
| **Всего**                                         |                  **2.73**                 | **88**       |  **8800**   |


| действия на странице                              | среднее количество в день на пользователя | средний RPS  | пиковый RPS |
|---------------------------------------------------|:-----------------------------------------:|--------------|-------------|
| добавление в избранное \ удаление из избранного   |                   0.1                     | 3            |  300        |
| подписка на уведомлени \ отписка от уведомлений   |                   0.1                     | 3            |  300        |
| получение исторических данных                     |                   5                       | 162          |  16 200     |
| **Всего**                                         |                  **5.2**                  | **168**      |  **16 800** |

| websocket                                         | среднее количество в день на пользователя | средний RPS  | пиковый RPS   |
|---------------------------------------------------|:-----------------------------------------:|--------------|---------------|
| получение уведомления                             |                   10                      | 7            |  700          |
| получение изменений цены                          |                   86400                   | 56 000       |  1 400 000    |
| **Всего**                                         |                  **86410**                | **56 007**   | **1 400 700** |

Я исхожу из предположения, что только каждый 50-ый пользователь держит длительное время страницу открытой. То есть только с 2% пользователей нужно единовременно держать активный Websocket - то есть с 140 тыс. пользователями. Сообщения через web-socket отправляются в среднем ~60 раз в минуту. 
Я предполагаю, что в моменты пиковой нагрузки сообщения через websocket начинаю передаваться в несколько раз реже, например, в 4 раза реже.

### Сетевой трафик

Нагрузку на сеть можно расчитать по формуле: нагрузка[Гбит/c] = средний_трафик_на_действие * RPS * 8 / 1024 

| посещаемые страницы                              | средний трафик на одно действие | средняя нагрузка на сеть | пиковая нагрузка на сеть |
|--------------------------------------------------|---------------------------------|--------------------------|--------------------------|
| посещение главной страницы                       | 36.7 Кб                         | 9.2 Мбит/с               |  0.9 Гбит/с           |
| посещение страницы отдельно взятой криптовалюты  | 64.4 Кб                         | 16.1 Мбит/с              |  1.57 Гбит/c           |
| получение ранжированного списка криптобирж       | 22.2 Кб                         | 5.57 Мбит/с              |  0.54 Гбит/c              |
| **Всего**                                        |                                 | **30.9 Мбит/c**          |  **3.01 Гбит/c**       |

| действия на странице                              | средний трафик на одно действие           | средняя нагрузка на сеть  | пиковая нагрузка на сеть |
|---------------------------------------------------|:-----------------------------------------:|---------------------------|--------------------------|
| добавление в избранное \ удаление из избранного   |                   1 Кб                    | 24 Кбит/с                 |  2.34 Мбит/с             |
| подписка на уведомлени \ отписка от уведомлений   |                   1 Кб                    | 24 Кбит/с                 |  2.34 Мбит/с             |
| получение исторических данных                     |                   30 Кб                   | 720 Кбит/с                |  70.31 Мбит/с            |
| **Всего**                                         |                                           | **768 Кбит/с**            |  **75 Мбит/с**           |

| websocket                                         | средний трафик на одно действие           | средняя нагрузка на сеть  | пиковая нагрузка на сеть |
|---------------------------------------------------|:-----------------------------------------:|---------------------------|--------------------------|
| получение уведомления                             |                   1.6 Кб                  | 89.6 Кбит/с               |  8.75 Мбит/с             |
| получение изменений цены                          |                   0.8 Кб                  | 350 Мбит/с                |  34.2 Гбит/c             |
| **Всего**                                         |                                           | **350.01 Мбит/с**         | **34.2 Гбит/c**          |


Браузер не даёт посмотреть конкретные значения трафика, пересылаемые через WebSocket, но даёт посмотреть длину сообщения.
Берём вес одного символа в 2 байта. Среднее сообщение в 410 символов. Среднее число сообщений в минуту - 60.
Получается 48 Кб в минуту.

## Источники
1. [According to CMC 2024](https://coinmarketcap.com/academy/article/according-to-cmc-2024-h1)
2. [coinmarketcap.com Trafic Analytics, Ranking & Audience August 2024](https://www.similarweb.com/website/coinmarketcap.com)
3. [coinmarketcap.com July 2024 Traffic Stats](https://www.semrush.com/website/coinmarketcap.com/overview/)
4. [Bitcoin Correlation Map](https://www.tradingview.com/script/74E9YRKI-Bitcoin-Correlation-Map/)
5. [Is There a Cryptocurrency Price Correlation to the Stock Market](https://www.investopedia.com/news/are-bitcoin-price-and-equity-markets-returns-correlated/)
6. [В 2023 году количество пользователей криптовалют в мире выросло на 34% — до 580 000 000 человек](https://dzen.ru/a/Za-LwZsN-BbkDSfq)


Доработки:

подумать о регистрации: то, что вот оно в куках лежит на клиенте, и при этом лежит ли что-то на сервере
как уведомления приходят без регистрации? заводятся ли отдельные 
посмотреть размер страницы без disable cash 
действия на странице

